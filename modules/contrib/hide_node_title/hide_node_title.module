<?php

/**
 * @file
 * Contains hide_node_title preprocess functions.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function hide_node_title_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the hide_node_title module.
    case 'help.page.hide_node_title':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Allows you to hide a node title when boolean field_hide_title field is checked') . '</p>';
      return $output;

    default;
  }
}

/**
 * Implements hook_preprocess_field().
 *
 * Removes title field from node display.
 */
function hide_node_title_preprocess_field(&$variables) {

  if ($variables['field_name'] == 'title') {
    if ($node = \Drupal::request()->attributes->get('node')) {
      if (isset($node->field_hide_title->value) &&
        $node->field_hide_title->value == 1) {
        foreach ($variables['items'] as $index => $item) {
          $variables['items'][$index]['content']['#context']['value'] = '';
        }
      }
    }
  }
}

/**
 * Implements hook_preprocess_ds_pre_render_alter().
 *
 * Removes title field from DS display.
 */
function hide_node_title_ds_pre_render_alter(&$layout_render_array, $context, &$vars) {

  // @todo integrate fix into exclude node title modules
  if ($vars['content']['#view_mode'] == 'full') {
    // Only applying to view_mode full.
    if (isset($context['entity'])) {
      $node = $context['entity'];
      if (isset($vars['content']['title']) &&
        isset($node->field_hide_title->value) &&
        $node->field_hide_title->value == 1) {
        foreach ($vars['content']['ds_content'] as $index => $item) {
          // First level loop through ds_content.
          if (isset($item['#field_name']) &&
            $item['#field_name'] == "node_title") {
            $vars['content']['ds_content'][$index]['0']['0']['#context'] = [];
          }
          elseif (isset($item['#type']) &&
            strpos($item['#type'], "field_group_") !== FALSE) {
            // If fields are nested in field group.
            foreach ($item as $index_group => $item_group) {
              // Second level loop through ds_content.
              if (isset($item_group['#field_name']) &&
                $item_group['#field_name'] == "node_title") {
                $vars['content']['ds_content'][$index]['node_title']['0']['0']['#context'] = [];
              }
            }
          }
        }
      }
    }
  }
}
